{% extends "layout.html" %}

{% block title %}AI Customer Support{% endblock %}

{% block styles %}
<style>
    .chat-container {
        height: 60vh;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.25rem;
        background-color: var(--bs-dark);
    }
    
    .message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 10px;
        position: relative;
    }
    
    .user-message {
        background-color: var(--bs-primary);
        color: white;
        margin-left: auto;
        border-top-right-radius: 0;
    }
    
    .ai-message {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        margin-right: auto;
        border-top-left-radius: 0;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
        margin-top: 5px;
        text-align: right;
    }
    
    .feedback-container {
        display: flex;
        justify-content: flex-end;
        margin-top: 8px;
    }
    
    .feedback-btn {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        margin-left: 5px;
    }
    
    .source-list {
        font-size: 0.8rem;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--bs-border-color);
    }
    
    .typing-indicator {
        background-color: var(--bs-secondary-bg);
        padding: 10px 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: none;
        margin-right: auto;
        width: fit-content;
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: var(--bs-secondary-color);
        display: inline-block;
        border-radius: 50%;
        margin-right: 2px;
        animation: typing 1.3s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0); }
    }
    
    .feedback-modal textarea {
        width: 100%;
        min-height: 100px;
    }
    
    .sources-toggle {
        font-size: 0.75rem;
        cursor: pointer;
        color: var(--bs-info);
        margin-top: 5px;
    }
    
    .welcome-message {
        text-align: center;
        padding: 30px;
        color: var(--bs-secondary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div style="background-color: #ffffff; border-radius: 8px; padding: 8px; display: inline-block; margin-right: 10px;">
                            <img src="/static/images/nvc_logo_main.png" alt="NVC Logo" style="height: 40px;">
                        </div>
                        <h2 class="mb-0">NVC AI Assistant</h2>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chatContainer">
                        <div class="welcome-message">
                            <h4>Welcome to NVC AI Customer Support</h4>
                            <p>Ask me anything about NVC Banking Platform features, processes, or services.</p>
                        </div>
                        <div class="typing-indicator" id="typingIndicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <form id="questionForm">
                            <div class="input-group">
                                <input type="text" class="form-control" id="questionInput" placeholder="Type your question here..." required>
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-lightbulb me-2"></i>
                        Suggested Questions
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h5>About NVC Platform</h5>
                            <ul class="list-unstyled">
                                <li><a href="#" class="suggested-question">What is NVCToken?</a></li>
                                <li><a href="#" class="suggested-question">How is NVCT backed?</a></li>
                                <li><a href="#" class="suggested-question">Is my data secure?</a></li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h5>Payments & Transfers</h5>
                            <ul class="list-unstyled">
                                <li><a href="#" class="suggested-question">How do I send a SWIFT transfer?</a></li>
                                <li><a href="#" class="suggested-question">What is a Server-to-Server transfer?</a></li>
                                <li><a href="#" class="suggested-question">What is EDI integration?</a></li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h5>Account Management</h5>
                            <ul class="list-unstyled">
                                <li><a href="#" class="suggested-question">How do I reset my password?</a></li>
                                <li><a href="#" class="suggested-question">How do I create an account?</a></li>
                                <li><a href="#" class="suggested-question">Who do I contact for support?</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">Provide Additional Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <input type="hidden" id="feedbackQuestion">
                    <input type="hidden" id="feedbackAnswer">
                    <input type="hidden" id="feedbackHelpful">
                    
                    <div class="mb-3">
                        <label for="feedbackText" class="form-label">How can we improve this answer?</label>
                        <textarea class="form-control" id="feedbackText"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitFeedback">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatContainer = document.getElementById('chatContainer');
        const questionForm = document.getElementById('questionForm');
        const questionInput = document.getElementById('questionInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        
        // Suggested questions
        document.querySelectorAll('.suggested-question').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const question = this.textContent;
                questionInput.value = question;
                askQuestion(question);
            });
        });
        
        // Handle question submission
        questionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (question) {
                askQuestion(question);
                questionInput.value = '';
            }
        });
        
        // Handle feedback submission
        document.getElementById('submitFeedback').addEventListener('click', function() {
            const feedbackData = {
                question: document.getElementById('feedbackQuestion').value,
                answer: document.getElementById('feedbackAnswer').value,
                helpful: document.getElementById('feedbackHelpful').value === 'true',
                feedback: document.getElementById('feedbackText').value
            };
            
            fetch('/support/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    feedbackModal.hide();
                }
            })
            .catch(error => console.error('Error submitting feedback:', error));
        });
        
        function askQuestion(question) {
            // Add user message
            addMessage(question, 'user');
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            scrollToBottom();
            
            // Send request to API
            fetch('/support/api/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question: question })
            })
            .then(response => response.json())
            .then(data => {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'ai', null, true);
                } else {
                    addMessage(data.answer, 'ai', data.sources);
                }
                
                scrollToBottom();
            })
            .catch(error => {
                console.error('Error asking question:', error);
                typingIndicator.style.display = 'none';
                addMessage('Sorry, there was an error processing your request. Please try again later.', 'ai', null, true);
                scrollToBottom();
            });
        }
        
        function addMessage(text, sender, sources = null, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            // Main message content
            messageDiv.innerHTML = `<div>${text}</div>`;
            
            // Add timestamp
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp;
            messageDiv.appendChild(timeDiv);
            
            // Add sources if available
            if (sources && sources.length > 0) {
                const sourcesToggle = document.createElement('div');
                sourcesToggle.className = 'sources-toggle';
                sourcesToggle.textContent = 'Show sources';
                messageDiv.appendChild(sourcesToggle);
                
                const sourcesList = document.createElement('div');
                sourcesList.className = 'source-list';
                sourcesList.style.display = 'none';
                sourcesList.innerHTML = '<strong>Sources:</strong><ul>' + 
                    sources.map(source => `<li>${source.title} (${source.source})</li>`).join('') +
                    '</ul>';
                messageDiv.appendChild(sourcesList);
                
                sourcesToggle.addEventListener('click', function() {
                    if (sourcesList.style.display === 'none') {
                        sourcesList.style.display = 'block';
                        sourcesToggle.textContent = 'Hide sources';
                    } else {
                        sourcesList.style.display = 'none';
                        sourcesToggle.textContent = 'Show sources';
                    }
                    scrollToBottom();
                });
            }
            
            // Add feedback buttons for AI responses
            if (sender === 'ai' && !isError) {
                const feedbackContainer = document.createElement('div');
                feedbackContainer.className = 'feedback-container';
                
                // Helpful button
                const helpfulBtn = document.createElement('button');
                helpfulBtn.className = 'btn btn-sm btn-outline-success feedback-btn';
                helpfulBtn.innerHTML = '<i class="fas fa-thumbs-up"></i> Helpful';
                helpfulBtn.addEventListener('click', function() {
                    submitFeedback(true, text);
                });
                
                // Not helpful button
                const notHelpfulBtn = document.createElement('button');
                notHelpfulBtn.className = 'btn btn-sm btn-outline-danger feedback-btn';
                notHelpfulBtn.innerHTML = '<i class="fas fa-thumbs-down"></i> Not Helpful';
                notHelpfulBtn.addEventListener('click', function() {
                    submitFeedback(false, text);
                });
                
                feedbackContainer.appendChild(helpfulBtn);
                feedbackContainer.appendChild(notHelpfulBtn);
                messageDiv.appendChild(feedbackContainer);
            }
            
            chatContainer.appendChild(messageDiv);
            
            // Remove welcome message if exists
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
        }
        
        function submitFeedback(helpful, answer) {
            // Find the last user message
            const userMessages = document.querySelectorAll('.user-message');
            const lastUserMessage = userMessages[userMessages.length - 1];
            const question = lastUserMessage ? lastUserMessage.querySelector('div').textContent : '';
            
            // Set values in the modal
            document.getElementById('feedbackQuestion').value = question;
            document.getElementById('feedbackAnswer').value = answer;
            document.getElementById('feedbackHelpful').value = helpful;
            
            // Show the modal
            feedbackModal.show();
        }
        
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });
</script>
{% endblock %}