{% extends 'base.html' %}

{% block title %}Accept Credit Card Payment{% endblock %}

{% block styles %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .payment-info {
        padding: 20px;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        margin-bottom: 20px;
    }
    .payment-method-selector {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('pos.pos_dashboard') }}">POS Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Accept Payment</li>
                </ol>
            </nav>
            <h1 class="display-5 fw-bold mb-4">
                <i class="fas fa-credit-card me-2"></i> Accept Credit Card Payment
            </h1>
            <p class="lead">Process payments securely via Stripe payment gateway.</p>
            <hr>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice-dollar me-2"></i> Payment Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('pos.accept_payment') }}" id="payment-form">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.account_holder_id.label(class="form-label") }}
                            {{ form.account_holder_id(class="form-select") }}
                            <div class="form-text">Select the account holder for this payment</div>
                            {% if form.account_holder_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.account_holder_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.amount.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.amount(class="form-control", placeholder="0.00") }}
                                    </div>
                                    <div class="form-text">Enter the payment amount</div>
                                    {% if form.amount.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.amount.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.currency.label(class="form-label") }}
                                    {{ form.currency(class="form-select") }}
                                    <div class="form-text">Select the payment currency</div>
                                    {% if form.currency.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.currency.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.customer_email.label(class="form-label") }}
                            {{ form.customer_email(class="form-control", placeholder="customer@example.com") }}
                            <div class="form-text">Email address where receipt will be sent (optional)</div>
                            {% if form.customer_email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.customer_email.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="2") }}
                            <div class="form-text">Description of what this payment is for</div>
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.save_card(class="form-check-input") }}
                                {{ form.save_card.label(class="form-check-label") }}
                                <div class="form-text">Store card for future payments (customer consent required)</div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i> Information
                    </h5>
                </div>
                <div class="card-body">
                    <h5>Secure Payments</h5>
                    <p>All credit card information is securely handled by Stripe and is never stored on our servers.</p>
                    
                    <h5>Supported Cards</h5>
                    <div class="d-flex gap-2 mb-3">
                        <i class="fab fa-cc-visa fa-2x"></i>
                        <i class="fab fa-cc-mastercard fa-2x"></i>
                        <i class="fab fa-cc-amex fa-2x"></i>
                        <i class="fab fa-cc-discover fa-2x"></i>
                    </div>
                    
                    <h5>Processing Times</h5>
                    <p>Payments are typically processed instantly, but may take up to 24 hours to settle.</p>
                    
                    <h5>Need Help?</h5>
                    <p>Contact our support team at <a href="mailto:support@nvcplatform.net">support@nvcplatform.net</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Form validation and submission handling
        $("#payment-form").on("submit", function(e) {
            // Validate form fields
            if (!validateForm()) {
                e.preventDefault();
                return false;
            }
            
            // Show loading state
            $(this).find('button[type="submit"]').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...').prop('disabled', true);
        });
        
        function validateForm() {
            let isValid = true;
            
            // Validate amount
            const amount = $("#amount").val();
            if (!amount || parseFloat(amount) <= 0) {
                showError("amount", "Please enter a valid amount greater than 0");
                isValid = false;
            } else {
                clearError("amount");
            }
            
            return isValid;
        }
        
        function showError(fieldId, message) {
            const field = $("#" + fieldId);
            field.addClass("is-invalid");
            
            // Check if error element already exists
            let errorElement = field.next(".invalid-feedback");
            if (errorElement.length === 0) {
                field.after('<div class="invalid-feedback">' + message + '</div>');
            } else {
                errorElement.text(message);
            }
        }
        
        function clearError(fieldId) {
            const field = $("#" + fieldId);
            field.removeClass("is-invalid");
            field.next(".invalid-feedback").remove();
        }
    });
</script>
{% endblock %}