{% extends 'base.html' %}

{% block title %}Send Payment to Credit Card{% endblock %}

{% block styles %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .card-input-container {
        padding: 15px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        margin-bottom: 10px;
    }
    #card-element {
        margin-bottom: 8px;
    }
    #card-errors {
        color: #dc3545;
        font-size: 14px;
        margin-top: 4px;
    }
    .card-brands {
        padding: 10px 0;
    }
    .card-brands i {
        font-size: 24px;
        margin-right: 10px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('pos.pos_dashboard') }}">POS Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Send Payment</li>
                </ol>
            </nav>
            <h1 class="display-5 fw-bold mb-4">
                <i class="fas fa-paper-plane me-2"></i> Send Payment to Credit Card
            </h1>
            <p class="lead">Send funds directly to a credit card from your accounts.</p>
            <hr>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i> Payment Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('pos.send_payment') }}" id="payment-form">
                        {{ form.hidden_tag() }}
                        {{ form.card_token }}
                        
                        <div class="mb-3">
                            {{ form.account_holder_id.label(class="form-label") }}
                            {{ form.account_holder_id(class="form-select") }}
                            <div class="form-text">Select the account holder that's sending the payment</div>
                            {% if form.account_holder_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.account_holder_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.account_id.label(class="form-label") }}
                            {{ form.account_id(class="form-select") }}
                            <div class="form-text">Select the account to withdraw funds from</div>
                            {% if form.account_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.account_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.amount.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.amount(class="form-control", placeholder="0.00") }}
                                    </div>
                                    <div class="form-text">Enter the payment amount</div>
                                    {% if form.amount.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.amount.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.currency.label(class="form-label") }}
                                    {{ form.currency(class="form-select") }}
                                    <div class="form-text">Select the payment currency</div>
                                    {% if form.currency.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.currency.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.recipient_name.label(class="form-label") }}
                            {{ form.recipient_name(class="form-control") }}
                            <div class="form-text">Enter the name of the recipient</div>
                            {% if form.recipient_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.recipient_name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="card-element" class="form-label">Card Information</label>
                            <div class="card-brands mb-2">
                                <i class="fab fa-cc-visa"></i>
                                <i class="fab fa-cc-mastercard"></i>
                                <i class="fab fa-cc-amex"></i>
                                <i class="fab fa-cc-discover"></i>
                            </div>
                            <div class="card-input-container">
                                <div id="card-element">
                                    <!-- Stripe Card Element will be inserted here -->
                                </div>
                                <div id="card-errors" role="alert"></div>
                            </div>
                            <div class="form-text">Enter the credit card details where funds will be sent</div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="2") }}
                            <div class="form-text">Description of what this payment is for</div>
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.save_recipient(class="form-check-input") }}
                                {{ form.save_recipient.label(class="form-check-label") }}
                                <div class="form-text">Save this recipient for future payments</div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i> Information
                    </h5>
                </div>
                <div class="card-body">
                    <h5>Secure Payments</h5>
                    <p>All credit card information is securely handled by Stripe and is never stored on our servers.</p>
                    
                    <h5>Processing Times</h5>
                    <p>Payments to credit cards are typically processed within 1-3 business days depending on the receiving bank.</p>
                    
                    <h5>Fees</h5>
                    <p>A standard processing fee of 2.9% + $0.30 will be applied to each transaction.</p>
                    
                    <h5>Need Help?</h5>
                    <p>Contact our support team at <a href="mailto:support@nvcplatform.net">support@nvcplatform.net</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    
    // Create card element
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
        style: {
            base: {
                color: '#32325d',
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: 'antialiased',
                fontSize: '16px',
                '::placeholder': {
                    color: '#aab7c4'
                }
            },
            invalid: {
                color: '#dc3545',
                iconColor: '#dc3545'
            }
        }
    });
    
    // Mount card element
    cardElement.mount('#card-element');
    
    // Handle real-time validation errors
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });
    
    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Disable submit button
        document.querySelector('button[type="submit"]').disabled = true;
        document.querySelector('button[type="submit"]').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        // Create a token for the card
        stripe.createToken(cardElement).then(function(result) {
            if (result.error) {
                // Display error
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
                
                // Re-enable submit button
                document.querySelector('button[type="submit"]').disabled = false;
                document.querySelector('button[type="submit"]').innerHTML = 'Send Payment';
            } else {
                // Set the token value in the hidden input
                document.getElementById('card_token').value = result.token.id;
                
                // Submit the form
                form.submit();
            }
        });
    });
    
    // Update account select options when account holder changes
    $('#account_holder_id').on('change', function() {
        const accountHolderId = $(this).val();
        if (!accountHolderId) return;
        
        // Show loading
        $('#account_id').html('<option value="">Loading accounts...</option>');
        
        // Fetch accounts for the selected account holder
        $.getJSON('/pos/api/get-account-holders', function(data) {
            if (data.success) {
                const accounts = data.account_holders.find(ah => ah.id == accountHolderId)?.accounts || [];
                
                // Populate account select
                let options = '<option value="">Select an account</option>';
                accounts.forEach(account => {
                    options += `<option value="${account.id}">${account.account_number} (${account.currency}) - Balance: ${account.balance}</option>`;
                });
                
                $('#account_id').html(options);
            }
        }).fail(function() {
            $('#account_id').html('<option value="">Failed to load accounts</option>');
        });
    });
</script>
{% endblock %}