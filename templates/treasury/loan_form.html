{% extends 'layout.html' %}

{% block title %}{% if is_new %}New Loan{% else %}Edit Loan{% endif %}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('treasury.dashboard') }}">Treasury</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('treasury.loan_list') }}">Loans</a></li>
          <li class="breadcrumb-item active" aria-current="page">{% if is_new %}New Loan{% else %}Edit Loan{% endif %}</li>
        </ol>
      </nav>
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{% if is_new %}New Loan{% else %}Edit Loan{% endif %}</h1>
        <a href="{{ url_for('treasury.loan_list') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i> Back to List
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Loan Details</h5>
        </div>
        <div class="card-body">
          <form method="POST" id="loan-form">
            {{ form.hidden_tag() }}
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.loan_type.label(class="form-label") }}
                  {{ form.loan_type(class="form-select") }}
                  {% if form.loan_type.errors %}
                  <div class="text-danger">
                    {% for error in form.loan_type.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.account_id.label(class="form-label") }}
                  {{ form.account_id(class="form-select") }}
                  {% if form.account_id.errors %}
                  <div class="text-danger">
                    {% for error in form.account_id.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.name.label(class="form-label") }}
                  {{ form.name(class="form-control") }}
                  {% if form.name.errors %}
                  <div class="text-danger">
                    {% for error in form.name.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.loan_id.label(class="form-label") }}
                  {{ form.loan_id(class="form-control", placeholder="Auto-generated if left empty") }}
                  {% if form.loan_id.errors %}
                  <div class="text-danger">
                    {% for error in form.loan_id.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.amount.label(class="form-label") }}
                  {{ form.amount(class="form-control") }}
                  {% if form.amount.errors %}
                  <div class="text-danger">
                    {% for error in form.amount.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.currency.label(class="form-label") }}
                  {{ form.currency(class="form-select") }}
                  {% if form.currency.errors %}
                  <div class="text-danger">
                    {% for error in form.currency.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.interest_rate.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.interest_rate(class="form-control") }}
                    <span class="input-group-text">%</span>
                  </div>
                  {% if form.interest_rate.errors %}
                  <div class="text-danger">
                    {% for error in form.interest_rate.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.interest_type.label(class="form-label") }}
                  {{ form.interest_type(class="form-select") }}
                  {% if form.interest_type.errors %}
                  <div class="text-danger">
                    {% for error in form.interest_type.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.payment_frequency.label(class="form-label") }}
                  {{ form.payment_frequency(class="form-select") }}
                  {% if form.payment_frequency.errors %}
                  <div class="text-danger">
                    {% for error in form.payment_frequency.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.start_date.label(class="form-label") }}
                  {{ form.start_date(class="form-control", type="date") }}
                  {% if form.start_date.errors %}
                  <div class="text-danger">
                    {% for error in form.start_date.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.maturity_date.label(class="form-label") }}
                  {{ form.maturity_date(class="form-control", type="date") }}
                  {% if form.maturity_date.errors %}
                  <div class="text-danger">
                    {% for error in form.maturity_date.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.next_payment_date.label(class="form-label") }}
                  {{ form.next_payment_date(class="form-control", type="date") }}
                  {% if form.next_payment_date.errors %}
                  <div class="text-danger">
                    {% for error in form.next_payment_date.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.term_years.label(class="form-label") }}
                  {{ form.term_years(class="form-control") }}
                  {% if form.term_years.errors %}
                  <div class="text-danger">
                    {% for error in form.term_years.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.term_months.label(class="form-label") }}
                  {{ form.term_months(class="form-control") }}
                  {% if form.term_months.errors %}
                  <div class="text-danger">
                    {% for error in form.term_months.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  {{ form.payment_amount.label(class="form-label") }}
                  {{ form.payment_amount(class="form-control") }}
                  {% if form.payment_amount.errors %}
                  <div class="text-danger">
                    {% for error in form.payment_amount.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="form-group">
                  {{ form.description.label(class="form-label") }}
                  {{ form.description(class="form-control", rows=3) }}
                  {% if form.description.errors %}
                  <div class="text-danger">
                    {% for error in form.description.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.lender.label(class="form-label") }}
                  {{ form.lender(class="form-control") }}
                  {% if form.lender.errors %}
                  <div class="text-danger">
                    {% for error in form.lender.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.collateral.label(class="form-label") }}
                  {{ form.collateral(class="form-control") }}
                  {% if form.collateral.errors %}
                  <div class="text-danger">
                    {% for error in form.collateral.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-between">
              <a href="{{ url_for('treasury.loan_list') }}" class="btn btn-outline-secondary">Cancel</a>
              <button type="submit" class="btn btn-primary">
                {% if is_new %}Create Loan{% else %}Update Loan{% endif %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Date validation
  document.getElementById('loan-form').addEventListener('submit', function(e) {
    const startDate = new Date(document.getElementById('start_date').value);
    const maturityDate = new Date(document.getElementById('maturity_date').value);
    
    if (maturityDate <= startDate) {
      e.preventDefault();
      alert('Maturity date must be after the start date.');
    }
  });
  
  // Calculate loan maturity date based on term
  function calculateMaturityDate() {
    const startDateStr = document.getElementById('start_date').value;
    if (!startDateStr) return;
    
    const startDate = new Date(startDateStr);
    const years = parseInt(document.getElementById('term_years').value) || 0;
    const months = parseInt(document.getElementById('term_months').value) || 0;
    
    if (years === 0 && months === 0) return;
    
    const maturityDate = new Date(startDate);
    maturityDate.setFullYear(maturityDate.getFullYear() + years);
    maturityDate.setMonth(maturityDate.getMonth() + months);
    
    document.getElementById('maturity_date').valueAsDate = maturityDate;
  }
  
  document.getElementById('start_date').addEventListener('change', calculateMaturityDate);
  document.getElementById('term_years').addEventListener('change', calculateMaturityDate);
  document.getElementById('term_months').addEventListener('change', calculateMaturityDate);
  
  // Set initial payment date
  document.getElementById('start_date').addEventListener('change', function() {
    if (document.getElementById('next_payment_date').value === '') {
      const startDate = new Date(this.value);
      if (startDate) {
        // Default to one month after start date for first payment
        const nextPaymentDate = new Date(startDate);
        nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
        document.getElementById('next_payment_date').valueAsDate = nextPaymentDate;
      }
    }
  });
</script>
{% endblock %}