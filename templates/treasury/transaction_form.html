{% extends 'layout.html' %}

{% block title %}{{ 'New Treasury Transaction' if is_new else 'Edit Treasury Transaction' }}{% endblock %}

{% block head %}
{{ super() }}
<style>
  /* Improved form styling */
  .form-control:focus, .form-select:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
  }
  
  /* Make the form elements stand out more */
  .form-control, .form-select {
    transition: all 0.2s ease-in-out;
    border-width: 2px;
  }
  
  /* Highlight required fields */
  .required-field::after {
    content: "*";
    color: #e74a3b;
    margin-left: 4px;
  }
  
  /* Processing indicator animation */
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .btn-processing {
    animation: pulse 1.5s infinite;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ 'New Treasury Transaction' if is_new else 'Edit Treasury Transaction' }}</h1>
        <div>
          <a href="{{ url_for('treasury.transaction_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i> All Transactions
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="POST" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.from_account_id.label(class="form-label required-field") }}
                  {{ form.from_account_id(class="form-select form-control-lg" + (" is-invalid" if form.from_account_id.errors else "")) }}
                  {% if form.from_account_id.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.from_account_id.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                  <small class="form-text text-muted">Select the source account for this transaction. Choose "External Account" for incoming transfers.</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.to_account_id.label(class="form-label required-field") }}
                  {{ form.to_account_id(class="form-select form-control-lg" + (" is-invalid" if form.to_account_id.errors else "")) }}
                  {% if form.to_account_id.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.to_account_id.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                  <small class="form-text text-muted">Select the destination account. Choose "External Account" for outgoing transfers.</small>
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.transaction_type.label(class="form-label required-field") }}
                  {{ form.transaction_type(class="form-select form-control-lg" + (" is-invalid" if form.transaction_type.errors else ""), autocomplete="on") }}
                  {% if form.transaction_type.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.transaction_type.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.amount.label(class="form-label required-field") }}
                  {{ form.amount(class="form-control form-control-lg" + (" is-invalid" if form.amount.errors else ""), 
                                 inputmode="decimal", step="0.01", placeholder="Enter amount", 
                                 autocomplete="on", min="0.01") }}
                  {% if form.amount.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.amount.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <!-- Currency is set automatically based on account selection -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Currency</label>
                  <input type="text" class="form-control" value="{{ from_account.currency if from_account else 'USD' }}" readonly>
                  <small class="text-muted">Currency is determined by the selected account</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Exchange Rate</label>
                  <input type="number" step="0.0001" class="form-control" value="1.0000" readonly>
                  <small class="form-text text-muted">Exchange rate if currencies differ between accounts. Default is 1.0.</small>
                </div>
              </div>
            </div>
            
            <div class="form-group mb-3">
              {{ form.reference_number.label(class="form-label") }}
              {{ form.reference_number(class="form-control" + (" is-invalid" if form.reference_number.errors else "")) }}
              {% if form.reference_number.errors %}
              <div class="invalid-feedback">
                {% for error in form.reference_number.errors %}
                {{ error }}
                {% endfor %}
              </div>
              {% endif %}
              <small class="form-text text-muted">Optional. A reference number for tracking or reconciliation.</small>
            </div>
            
            <div class="form-group mb-3">
              {{ form.description.label(class="form-label") }}
              {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows=2) }}
              {% if form.description.errors %}
              <div class="invalid-feedback">
                {% for error in form.description.errors %}
                {{ error }}
                {% endfor %}
              </div>
              {% endif %}
              <small class="form-text text-muted">A brief description of the transaction.</small>
            </div>
            
            <!-- Additional notes section -->
            <div class="form-group mb-4">
              <label class="form-label">Additional Notes</label>
              <textarea class="form-control" rows="3" name="additional_notes"></textarea>
              <small class="form-text text-muted">Optional. Additional notes about this transaction.</small>
            </div>
            
            <div class="alert alert-info mb-4">
              <i class="fas fa-info-circle me-2"></i>
              After creating the transaction, it will be in a <strong>Pending</strong> status. An administrator will need to approve it to complete the transfer and update account balances.
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a href="{{ url_for('treasury.transaction_list') }}" class="btn btn-outline-secondary btn-lg me-md-2">
                <i class="fas fa-times me-1"></i> Cancel
              </a>
              {{ form.submit(class="btn btn-primary btn-lg", id="submit-button") }}
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Transaction Types</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Internal Transfer</h6>
            <p class="small text-muted">Transfers between treasury accounts within your organization.</p>
          </div>
          <div class="mb-3">
            <h6>External Transfer</h6>
            <p class="small text-muted">Transfers to or from external parties like suppliers or customers.</p>
          </div>
          <div class="mb-3">
            <h6>Investment Purchase</h6>
            <p class="small text-muted">Purchasing an investment asset such as a certificate of deposit or bond.</p>
          </div>
          <div class="mb-3">
            <h6>Investment Maturity</h6>
            <p class="small text-muted">Receiving funds from a matured investment.</p>
          </div>
          <div class="mb-3">
            <h6>Loan Payment</h6>
            <p class="small text-muted">Payment towards a loan's principal and/or interest.</p>
          </div>
          <div class="mb-3">
            <h6>Interest Payment</h6>
            <p class="small text-muted">Interest earnings or payments on accounts or instruments.</p>
          </div>
          <div class="mb-3">
            <h6>Fee Payment</h6>
            <p class="small text-muted">Bank or service fees associated with maintaining accounts.</p>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Tips</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">Always include a clear description to help with future reconciliation.</li>
            <li class="list-group-item">Use the reference number for tracking payments in external systems.</li>
            <li class="list-group-item">Check that account balances are sufficient before initiating transfers.</li>
            <li class="list-group-item">For international transfers, verify the exchange rate is current and accurate.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get form elements
    const form = document.querySelector('form.needs-validation');
    const submitButton = document.getElementById('submit-button');
    const fromAccountSelect = document.getElementById('from_account_id');
    const toAccountSelect = document.getElementById('to_account_id');
    const transactionTypeSelect = document.getElementById('transaction_type');
    const amountInput = document.getElementById('amount');
    
    // Optimize form elements for faster interaction
    form.setAttribute('autocomplete', 'on');
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Allow Ctrl+S to submit the form
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        submitForm();
      }
      // Allow Escape to cancel
      if (e.key === 'Escape') {
        e.preventDefault();
        window.location.href = "{{ url_for('treasury.transaction_list') }}";
      }
      // Allow Alt+N to focus on next field
      if (e.altKey && e.key === 'n') {
        e.preventDefault();
        focusNextField();
      }
    });
    
    // Function to focus on next form field
    function focusNextField() {
      const focusableElements = Array.from(form.querySelectorAll('input, select, textarea, button'))
        .filter(el => !el.disabled && el.offsetParent !== null);
      
      const currentIndex = focusableElements.indexOf(document.activeElement);
      const nextIndex = (currentIndex + 1) % focusableElements.length;
      
      focusableElements[nextIndex].focus();
    }
    
    // Make dropdown selects more responsive
    [fromAccountSelect, toAccountSelect, transactionTypeSelect].forEach(select => {
      select.addEventListener('focus', function() {
        this.classList.add('shadow-sm');
      });
      
      select.addEventListener('blur', function() {
        this.classList.remove('shadow-sm');
      });
      
      // Fast typing-based selection
      select.addEventListener('keyup', function(e) {
        if (e.key.length === 1) { // Only for printable characters
          for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].text.toLowerCase().startsWith(e.key.toLowerCase())) {
              select.selectedIndex = i;
              break;
            }
          }
        }
      });
    });
    
    // Format amount with commas as user types
    amountInput.addEventListener('input', function() {
      const value = this.value.replace(/,/g, '');
      
      // Only proceed if it's a valid number
      if (!isNaN(parseFloat(value))) {
        // Format with commas for thousands
        const parts = value.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        this.value = parts.join('.');
      }
    });
    
    // Form validation and submission handling
    function submitForm() {
      // Visual feedback - show processing state
      submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
      submitButton.disabled = true;
      submitButton.classList.add('btn-processing');
      
      // Basic validation before submission
      let valid = true;
      
      // Validate account selection (can't both be external)
      if (fromAccountSelect.value === '0' && toAccountSelect.value === '0') {
        valid = false;
        fromAccountSelect.classList.add('is-invalid');
        toAccountSelect.classList.add('is-invalid');
        
        // Add custom error message if it doesn't exist
        let errorMsg = document.getElementById('account-error-message');
        if (!errorMsg) {
          errorMsg = document.createElement('div');
          errorMsg.id = 'account-error-message';
          errorMsg.className = 'invalid-feedback d-block mt-2 alert alert-danger';
          errorMsg.innerHTML = 'Both source and destination cannot be external accounts.';
          fromAccountSelect.parentNode.appendChild(errorMsg);
        }
      }
      
      // If valid, submit the form after a small delay to allow UI update
      if (valid) {
        setTimeout(() => {
          form.submit();
        }, 100);
      } else {
        // Reset button state if validation fails
        submitButton.innerHTML = 'Create Transaction';
        submitButton.disabled = false;
        submitButton.classList.remove('btn-processing');
      }
    }
    
    // Attach submit handler
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      submitForm();
    });
    
    // Focus on first field to speed up data entry
    fromAccountSelect.focus();
    
    // Set up tab order
    fromAccountSelect.tabIndex = 1;
    toAccountSelect.tabIndex = 2;
    transactionTypeSelect.tabIndex = 3;
    amountInput.tabIndex = 4;
    document.getElementById('reference_number').tabIndex = 5;
    document.getElementById('description').tabIndex = 6;
    document.querySelector('textarea[name="additional_notes"]').tabIndex = 7;
    submitButton.tabIndex = 8;
    
    // Add keyboard shortcut hints
    const shortcutsHint = document.createElement('div');
    shortcutsHint.className = 'alert alert-info mt-3';
    shortcutsHint.innerHTML = `
      <strong>Keyboard shortcuts:</strong>
      <ul class="mb-0">
        <li><kbd>Ctrl</kbd>+<kbd>S</kbd> - Submit form</li>
        <li><kbd>Esc</kbd> - Cancel and return to list</li>
        <li><kbd>Alt</kbd>+<kbd>N</kbd> - Move to next field</li>
      </ul>
    `;
    document.querySelector('.card-body').appendChild(shortcutsHint);
  });
</script>
{% endblock %}
{% endblock %}