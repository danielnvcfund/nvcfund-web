{% extends 'layout.html' %}

{% block title %}{{ 'New Treasury Transaction' if is_new else 'Edit Treasury Transaction' }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ 'New Treasury Transaction' if is_new else 'Edit Treasury Transaction' }}</h1>
        <div>
          <a href="{{ url_for('treasury.transaction_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i> All Transactions
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="POST" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.from_account_id.label(class="form-label") }}
                  {{ form.from_account_id(class="form-select" + (" is-invalid" if form.from_account_id.errors else "")) }}
                  {% if form.from_account_id.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.from_account_id.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                  <small class="form-text text-muted">Select the source account for this transaction. Choose "External Account" for incoming transfers.</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.to_account_id.label(class="form-label") }}
                  {{ form.to_account_id(class="form-select" + (" is-invalid" if form.to_account_id.errors else "")) }}
                  {% if form.to_account_id.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.to_account_id.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                  <small class="form-text text-muted">Select the destination account. Choose "External Account" for outgoing transfers.</small>
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.transaction_type.label(class="form-label") }}
                  {{ form.transaction_type(class="form-select" + (" is-invalid" if form.transaction_type.errors else "")) }}
                  {% if form.transaction_type.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.transaction_type.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.amount.label(class="form-label") }}
                  {{ form.amount(class="form-control" + (" is-invalid" if form.amount.errors else ""), type="number", step="0.01") }}
                  {% if form.amount.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.amount.errors %}
                    {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-3">
              <!-- Currency is set automatically based on account selection -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Currency</label>
                  <input type="text" class="form-control" value="{{ from_account.currency if from_account else 'USD' }}" readonly>
                  <small class="text-muted">Currency is determined by the selected account</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Exchange Rate</label>
                  <input type="number" step="0.0001" class="form-control" value="1.0000" readonly>
                  <small class="form-text text-muted">Exchange rate if currencies differ between accounts. Default is 1.0.</small>
                </div>
              </div>
            </div>
            
            <div class="form-group mb-3">
              {{ form.reference_number.label(class="form-label") }}
              {{ form.reference_number(class="form-control" + (" is-invalid" if form.reference_number.errors else "")) }}
              {% if form.reference_number.errors %}
              <div class="invalid-feedback">
                {% for error in form.reference_number.errors %}
                {{ error }}
                {% endfor %}
              </div>
              {% endif %}
              <small class="form-text text-muted">Optional. A reference number for tracking or reconciliation.</small>
            </div>
            
            <div class="form-group mb-3">
              {{ form.description.label(class="form-label") }}
              {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows=2) }}
              {% if form.description.errors %}
              <div class="invalid-feedback">
                {% for error in form.description.errors %}
                {{ error }}
                {% endfor %}
              </div>
              {% endif %}
              <small class="form-text text-muted">A brief description of the transaction.</small>
            </div>
            
            <!-- Additional notes section -->
            <div class="form-group mb-4">
              <label class="form-label">Additional Notes</label>
              <textarea class="form-control" rows="3" name="additional_notes"></textarea>
              <small class="form-text text-muted">Optional. Additional notes about this transaction.</small>
            </div>
            
            <div class="alert alert-info mb-4">
              <i class="fas fa-info-circle me-2"></i>
              After creating the transaction, it will be in a <strong>Pending</strong> status. An administrator will need to approve it to complete the transfer and update account balances.
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a href="{{ url_for('treasury.transaction_list') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
              {{ form.submit(class="btn btn-primary") }}
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Transaction Types</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Internal Transfer</h6>
            <p class="small text-muted">Transfers between treasury accounts within your organization.</p>
          </div>
          <div class="mb-3">
            <h6>External Transfer</h6>
            <p class="small text-muted">Transfers to or from external parties like suppliers or customers.</p>
          </div>
          <div class="mb-3">
            <h6>Investment Purchase</h6>
            <p class="small text-muted">Purchasing an investment asset such as a certificate of deposit or bond.</p>
          </div>
          <div class="mb-3">
            <h6>Investment Maturity</h6>
            <p class="small text-muted">Receiving funds from a matured investment.</p>
          </div>
          <div class="mb-3">
            <h6>Loan Payment</h6>
            <p class="small text-muted">Payment towards a loan's principal and/or interest.</p>
          </div>
          <div class="mb-3">
            <h6>Interest Payment</h6>
            <p class="small text-muted">Interest earnings or payments on accounts or instruments.</p>
          </div>
          <div class="mb-3">
            <h6>Fee Payment</h6>
            <p class="small text-muted">Bank or service fees associated with maintaining accounts.</p>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Tips</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">Always include a clear description to help with future reconciliation.</li>
            <li class="list-group-item">Use the reference number for tracking payments in external systems.</li>
            <li class="list-group-item">Check that account balances are sufficient before initiating transfers.</li>
            <li class="list-group-item">For international transfers, verify the exchange rate is current and accurate.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}