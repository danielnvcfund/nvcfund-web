{% extends "layout.html" %}

{% block title %}Create Standby Letter of Credit - NVC Banking Platform{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('web.main.dashboard') }}">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('swift.sblc_list') }}">Standby Letters of Credit</a></li>
          <li class="breadcrumb-item active">{% if edit_mode %}Edit{% else %}Create{% endif %} SBLC</li>
        </ol>
      </nav>
      
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h2 class="h4 mb-0">{% if edit_mode %}Edit{% else %}Create{% endif %} Standby Letter of Credit</h2>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Standby Letters of Credit (SBLCs) are contingent payment instruments that ensure financial obligations are met. They function as a bank guarantee to make payment in case of non-performance by the applicant.
          </div>
          
          <form method="POST" id="sblc-form" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- SBLC Basic Information -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h3 class="h5 mb-0">SBLC Basic Information</h3>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.amount.id }}" class="form-label required">Amount</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                      {{ form.amount(class="form-control", required=True, placeholder="0.00") }}
                    </div>
                    {% if form.amount.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.amount.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.currency.id }}" class="form-label required">Currency</label>
                    {{ form.currency(class="form-select", required=True) }}
                    {% if form.currency.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.currency.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.issue_date.id }}" class="form-label required">Issue Date</label>
                    {{ form.issue_date(class="form-control", type="date", required=True) }}
                    {% if form.issue_date.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.issue_date.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.expiry_date.id }}" class="form-label required">Expiry Date</label>
                    {{ form.expiry_date(class="form-control", type="date", required=True) }}
                    {% if form.expiry_date.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.expiry_date.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.expiry_place.id }}" class="form-label required">Place of Expiry</label>
                    {{ form.expiry_place(class="form-control", required=True, placeholder="Enter location where SBLC expires") }}
                    {% if form.expiry_place.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.expiry_place.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.applicable_law.id }}" class="form-label required">Applicable Law/Jurisdiction</label>
                    {{ form.applicable_law(class="form-control", required=True, placeholder="E.g., Laws of England and Wales") }}
                    {% if form.applicable_law.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.applicable_law.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      {{ form.partial_drawings(class="form-check-input") }}
                      <label class="form-check-label" for="{{ form.partial_drawings.id }}">
                        Allow Partial Drawings
                      </label>
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      {{ form.multiple_drawings(class="form-check-input") }}
                      <label class="form-check-label" for="{{ form.multiple_drawings.id }}">
                        Allow Multiple Drawings
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Applicant Information -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h3 class="h5 mb-0">Applicant Information</h3>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.applicant_id.id }}" class="form-label required">Select Applicant</label>
                    {{ form.applicant_id(class="form-select", required=True) }}
                    {% if form.applicant_id.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.applicant_id.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.applicant_account_number.id }}" class="form-label required">Applicant Account Number</label>
                    {{ form.applicant_account_number(class="form-control", required=True, placeholder="Enter account number") }}
                    {% if form.applicant_account_number.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.applicant_account_number.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.applicant_contact_info.id }}" class="form-label">Contact Information</label>
                    {{ form.applicant_contact_info(class="form-control", placeholder="Contact person, email, phone") }}
                    {% if form.applicant_contact_info.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.applicant_contact_info.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Beneficiary Information -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h3 class="h5 mb-0">Beneficiary Information</h3>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.beneficiary_name.id }}" class="form-label required">Beneficiary Name</label>
                    {{ form.beneficiary_name(class="form-control", required=True, placeholder="Enter full legal name") }}
                    {% if form.beneficiary_name.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.beneficiary_name.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.beneficiary_address.id }}" class="form-label required">Beneficiary Address</label>
                    {{ form.beneficiary_address(class="form-control", required=True, rows=3, placeholder="Enter complete address") }}
                    {% if form.beneficiary_address.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.beneficiary_address.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.beneficiary_account_number.id }}" class="form-label">Beneficiary Account Number</label>
                    {{ form.beneficiary_account_number(class="form-control", placeholder="Enter account number") }}
                    {% if form.beneficiary_account_number.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.beneficiary_account_number.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.beneficiary_bank_name.id }}" class="form-label required">Beneficiary's Bank Name</label>
                    {{ form.beneficiary_bank_name(class="form-control", required=True, placeholder="Enter bank name") }}
                    {% if form.beneficiary_bank_name.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.beneficiary_bank_name.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.beneficiary_bank_swift.id }}" class="form-label required">Beneficiary's Bank SWIFT Code</label>
                    {{ form.beneficiary_bank_swift(class="form-control", required=True, placeholder="Enter SWIFT/BIC code") }}
                    {% if form.beneficiary_bank_swift.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.beneficiary_bank_swift.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.beneficiary_bank_address.id }}" class="form-label">Beneficiary's Bank Address</label>
                    {{ form.beneficiary_bank_address(class="form-control", rows=3, placeholder="Enter bank address") }}
                    {% if form.beneficiary_bank_address.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.beneficiary_bank_address.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Underlying Transaction -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h3 class="h5 mb-0">Underlying Transaction</h3>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.contract_name.id }}" class="form-label required">Contract/Agreement Name</label>
                    {{ form.contract_name(class="form-control", required=True, placeholder="Enter name of the underlying contract") }}
                    {% if form.contract_name.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.contract_name.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.contract_date.id }}" class="form-label required">Contract/Agreement Date</label>
                    {{ form.contract_date(class="form-control", type="date", required=True) }}
                    {% if form.contract_date.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.contract_date.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.contract_details.id }}" class="form-label">Contract/Agreement Details</label>
                    {{ form.contract_details(class="form-control", rows=4, placeholder="Brief description of the underlying contract") }}
                    {% if form.contract_details.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.contract_details.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Terms and Conditions -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h3 class="h5 mb-0">Terms and Conditions</h3>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.special_conditions.id }}" class="form-label">Special Conditions</label>
                    {{ form.special_conditions(class="form-control", rows=6, placeholder="Enter any special terms and conditions for this SBLC") }}
                    {% if form.special_conditions.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.special_conditions.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                    <div class="form-text">Include any special instructions, drawing conditions, or additional clauses.</div>
                  </div>
                  
                  <div class="col-md-12">
                    <div class="form-check">
                      {{ form.confirm_terms(class="form-check-input", required=True) }}
                      <label class="form-check-label required" for="{{ form.confirm_terms.id }}">
                        I confirm that all information provided is accurate and complete. This SBLC will be subject to the International Standby Practices, International Chamber of Commerce Publication No. 590 (ISP98).
                      </label>
                      {% if form.confirm_terms.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.confirm_terms.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Submit Buttons -->
            <div class="d-flex justify-content-between">
              <a href="{{ url_for('swift.sblc_list') }}" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i> Cancel
              </a>
              <div>
                <button type="submit" name="save_draft" value="true" class="btn btn-primary me-2">
                  <i class="fas fa-save me-1"></i> Save as Draft
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-check-circle me-1"></i> {% if edit_mode %}Update{% else %}Create{% endif %} SBLC
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Auto-populate applicant account number based on selected applicant
    $('#{{ form.applicant_id.id }}').change(function() {
      var applicantId = $(this).val();
      if (applicantId) {
        $.get("{{ url_for('swift.get_applicant_details') }}", {applicant_id: applicantId}, function(data) {
          if (data.success) {
            $('#{{ form.applicant_account_number.id }}').val(data.account_number);
          }
        });
      }
    });
    
    // Form validation
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
          form.addEventListener('submit', function(event) {
            if (form.checkValidity() === false) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  });
</script>
{% endblock %}
{% endblock %}